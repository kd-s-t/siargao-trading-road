name: Mobile Build

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'reactnative/**'
      - '.github/workflows/mobile-build.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'reactnative/**'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: 'Build profile'
        required: true
        type: choice
        options:
          - preview
          - production

jobs:
  build:
    name: Build Mobile App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./reactnative

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: reactnative/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create builds directory
        run: mkdir -p builds

      - name: Set API URL
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.profile }}" == "production" ]; then
            echo "EXPO_PUBLIC_API_URL=https://${{ secrets.API_DOMAIN }}/api" >> .env
          else
            echo "EXPO_PUBLIC_API_URL=${{ secrets.API_URL || 'https://staging-api.example.com/api' }}" >> .env
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Build Android
        if: |
          (github.event_name == 'workflow_dispatch' && (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all')) ||
          (github.event_name != 'workflow_dispatch' && github.ref == 'refs/heads/main')
        id: build_android
        run: |
          BUILD_ID=$(eas build --platform android \
            --profile ${{ github.event.inputs.profile || 'preview' }} \
            --non-interactive \
            --json | jq -r '.id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Waiting for Android build to complete..."
          eas build:wait --id $BUILD_ID --non-interactive
          echo "Android build completed: $BUILD_ID"

      - name: Download and Upload Android to S3
        if: steps.build_android.outputs.build_id != ''
        run: |
          BUILD_ID=${{ steps.build_android.outputs.build_id }}
          echo "Downloading Android build $BUILD_ID..."
          eas build:download --id $BUILD_ID --output ./builds/android.apk --non-interactive
          
          VERSION=$(node -p "require('./app.json').expo.version")
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          S3_KEY="android/wholesale-${VERSION}-${COMMIT_SHA}-${TIMESTAMP}.apk"
          S3_KEY_LATEST="android/latest.apk"
          
          echo "Uploading to S3..."
          aws s3 cp ./builds/android.apk s3://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}/$S3_KEY
          aws s3 cp ./builds/android.apk s3://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}/$S3_KEY_LATEST
          
          DOWNLOAD_URL="https://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}.s3.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com/$S3_KEY"
          LATEST_URL="https://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}.s3.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com/$S3_KEY_LATEST"
          
          echo "Download URL: $DOWNLOAD_URL"
          echo "Latest URL: $LATEST_URL"
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "latest_url=$LATEST_URL" >> $GITHUB_OUTPUT

      - name: Build iOS
        if: |
          (github.event_name == 'workflow_dispatch' && (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all')) ||
          (github.event_name != 'workflow_dispatch' && github.ref == 'refs/heads/main')
        id: build_ios
        run: |
          BUILD_ID=$(eas build --platform ios \
            --profile ${{ github.event.inputs.profile || 'preview' }} \
            --non-interactive \
            --json | jq -r '.id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Waiting for iOS build to complete..."
          eas build:wait --id $BUILD_ID --non-interactive
          echo "iOS build completed: $BUILD_ID"

      - name: Download and Upload iOS to S3
        if: steps.build_ios.outputs.build_id != ''
        run: |
          BUILD_ID=${{ steps.build_ios.outputs.build_id }}
          echo "Downloading iOS build $BUILD_ID..."
          eas build:download --id $BUILD_ID --output ./builds/ios.ipa --non-interactive
          
          VERSION=$(node -p "require('./app.json').expo.version")
          COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          S3_KEY="ios/wholesale-${VERSION}-${COMMIT_SHA}-${TIMESTAMP}.ipa"
          S3_KEY_LATEST="ios/latest.ipa"
          
          echo "Uploading to S3..."
          aws s3 cp ./builds/ios.ipa s3://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}/$S3_KEY
          aws s3 cp ./builds/ios.ipa s3://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}/$S3_KEY_LATEST
          
          DOWNLOAD_URL="https://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}.s3.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com/$S3_KEY"
          LATEST_URL="https://${{ secrets.S3_MOBILE_BUILDS_BUCKET }}.s3.${{ secrets.AWS_REGION || 'us-east-1' }}.amazonaws.com/$S3_KEY_LATEST"
          
          echo "Download URL: $DOWNLOAD_URL"
          echo "Latest URL: $LATEST_URL"
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "latest_url=$LATEST_URL" >> $GITHUB_OUTPUT

      - name: Comment Download Links
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const androidUrl = '${{ steps.build_android.outputs.download_url }}';
            const iosUrl = '${{ steps.build_ios.outputs.download_url }}';
            
            let comment = '## ðŸ“± Mobile Build Complete\n\n';
            
            if (androidUrl) {
              comment += `### Android\n`;
              comment += `- **Download**: [APK](${androidUrl})\n`;
              comment += `- **Latest**: [latest.apk](${{ steps.build_android.outputs.latest_url }})\n\n`;
            }
            
            if (iosUrl) {
              comment += `### iOS\n`;
              comment += `- **Download**: [IPA](${iosUrl})\n`;
              comment += `- **Latest**: [latest.ipa](${{ steps.build_ios.outputs.latest_url }})\n\n`;
            }
            
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

